sudo: required
language: php
dist: bionic
php:
- 7.4
services:
- docker
stages:
- lint
- test
- deploy
env:
  global:
  - GIT_HOST="{{ PANTHEON_GIT_HOST }}"
  - PANTHEON_GIT_URL="{{ PANTHEON_GIT_URL }}"
  - secure: bjrx+ngmKazdmtdhq7hoduP2FiEUfumKcv0KGrIW0hm9yEEzwocEPW0xnh5N+1nirDAGkvQn2ml7tRnfKOcMMvL3zM+4pwolWumHuPKMqTonP1nDBm3X+Sr0yjPMTXMPRbS8J1HsTDBls9fm6JzuA5UzBKoc9BbNNiGSRswWY8RCr+RqzLN0LxcUOCLHE6IE4RSm8VMX1eRZMwHcxIehKiIeJVfYg4xt5mRN9G87aSWcrl/xOe6Y+cwMBvYVhfZR/eWZ1eWCJQTE75maDKd3csTC0aDGGW6p6knM/i0s+UaqdDLzzC1GKgohUnQh3BiW0gee9LMWpJahPyyo3n40iLf0RggWR09q1eF+5PXpaXamTSsJD2XoT8lOyqKQgOZJ5bzey7b8vCIPSW/gXBhkMC3aUGm8gmJvNOvumxLguideky5iqX+1feJKed7Rhwn0Vn0J8HAt4lffZ17HAVHyglm5RlpULb/2WXz5+/8P8cSAqSjLQoyL7s4nrsMKFFHNAiQnSJQ2ymcrhoWvw8diIoKqCcxNUvuvfL/hr1INI7rWrdrWw4n18ySl8nVZJf6n7L+s29awgCzfWXmREAYmr0G8x5uv+y8ISu7v0sRQZkkIlmKb9srD7QRiD5v85EhX3FzEd5mjRm3bmldeNmTnfp13XeVEv8DqyXb6NTyYy88=
before_install:
- export PATH="$HOME/.config/composer/vendor/bin:$PATH"
- docker login --password "$DOCKER_PASSWORD" --username arongizra
jobs:
  include:
  - stage: Lint
    name: PhpStan
    script:
    - composer install
    - vendor/bin/phpstan analyse -c phpstan.neon
  - stage: Lint
    name: 'Drupal coding standard: phpcs'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_coder.sh || travis_terminate 1;"
    - export REVIEW_STANDARD="Drupal" && $TRAVIS_BUILD_DIR/ci-scripts/test_coder.sh
  - stage: Lint
    name: 'Drupal coding best practices: phpcs'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_coder.sh || travis_terminate 1;"
    - export REVIEW_STANDARD="DrupalPractice" && $TRAVIS_BUILD_DIR/ci-scripts/test_coder.sh
  - stage: Lint
    name: 'Shell coding standard: shellcheck'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_shell.sh || travis_terminate 1;"
    - "$TRAVIS_BUILD_DIR/ci-scripts/test_shell.sh || travis_terminate 1;"
  - stage: Test
    name: 'Backend tests: Functional tests'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_ddev.sh || travis_terminate 1;"
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_drupal.sh || travis_terminate 1;"
    - "$TRAVIS_BUILD_DIR/ci-scripts/test_phpunit.sh || travis_terminate 1;"
  - stage: Deploy
    name: Deploy to Pantheon
    if: branch = "{{ GITHUB_DEPLOY_BRANCH }}" AND type = push
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_ddev.sh"
    - "$TRAVIS_BUILD_DIR/ci-scripts/prepare_deploy.sh"
    - ddev robo deploy:pantheon --no-interaction {{ PANTHEON_DEPLOY_BRANCH }}
