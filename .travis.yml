sudo: required
language: php
dist: bionic
php:
- 7.4
services:
- docker
stages:
- lint
- test
- deploy
env:
  global:
  - GIT_HOST="{{ PANTHEON_GIT_HOST }}"
  - PANTHEON_GIT_URL="{{ PANTHEON_GIT_URL }}"
  - secure: FqZSk2d5z/tAwVvHBBgfnlzmPpvg3b9Iw0vySLvuXXe+G/kH5DJQ4dXWCU9HSG7tJmiQb2BPq91G3bvrlSzGKPugSPU0Zfz+K5w4K8a1sYWXubtoUaJHZbj5aHZlJmfF6x6phnTY75AQQ/Q8Mfo91OHrj76ePNE2Tdls+55MPQb3ww+cdjyHmtY+UMEO4YgC45Z20mdMXOizxdXtvDKv0tuYxiUbmhySDNnbDimERKDq/j6HLDRmblWzbMNpJuI85m5r22ELw4e6tOObXQe58Q60YmRlOHnIVZQg3bfi4qaJDyl9XFHN7t9PJxE5ihGsuZR4fYiXLzvh0Gdpkt9c8vU3+n2dgR0krcOQmqJzd6CB6/1aIlL8Ctx6A/990z7owOaXvohdZwAE4ORZg8Ul5QPHVjwl72i6H9sfjCRlaPJ5+TH1WPN7C/yZRO9h+CIfIpcrs2RaCDrTEjW8edJxjxVVrRj7UpPkhhVI9MU4CJgykGFzfupma3OFsct7thPDOcTD/kWJA/QO8xUFkUMWIexyLsL8ZfGQ8QnPQPhFSYXZhVowy384NMjuDGdlZckbhTpTs6VUuxHwskC3IZh1rzuDyM/4/iwqoV3B4DGDH43iuPiwn/Vgd2PB1MWTQIUfineWs2VT/3IJp19Cg8+GidWwX5ogHKCMwNg53aZtnZ8=
before_install:
- export PATH="$HOME/.config/composer/vendor/bin:$PATH"
- docker login --password "$DOCKER_PASSWORD" --username arongizra
jobs:
  include:
  - stage: Lint
    name: PhpStan
    script:
    - composer install
    - vendor/bin/phpstan analyse -c phpstan.neon
  - stage: Lint
    name: 'Drupal coding standard: phpcs'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_coder.sh || travis_terminate 1;"
    - export REVIEW_STANDARD="Drupal" && $TRAVIS_BUILD_DIR/ci-scripts/test_coder.sh
  - stage: Lint
    name: 'Drupal coding best practices: phpcs'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_coder.sh || travis_terminate 1;"
    - export REVIEW_STANDARD="DrupalPractice" && $TRAVIS_BUILD_DIR/ci-scripts/test_coder.sh
  - stage: Lint
    name: 'Shell coding standard: shellcheck'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_shell.sh || travis_terminate 1;"
    - "$TRAVIS_BUILD_DIR/ci-scripts/test_shell.sh || travis_terminate 1;"
  - stage: Test
    name: 'Backend tests: Functional tests'
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_ddev.sh || travis_terminate 1;"
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_drupal.sh || travis_terminate 1;"
    - "$TRAVIS_BUILD_DIR/ci-scripts/test_phpunit.sh || travis_terminate 1;"
  - stage: Deploy
    name: Deploy to Pantheon
    if: branch = "{{ GITHUB_DEPLOY_BRANCH }}" AND type = push
    script:
    - "$TRAVIS_BUILD_DIR/ci-scripts/install_ddev.sh"
    - "$TRAVIS_BUILD_DIR/ci-scripts/prepare_deploy.sh"
    - ddev robo deploy:pantheon --no-interaction {{ PANTHEON_DEPLOY_BRANCH }}
